openapi: 3.0.3
info:
  title: Median Code API
  description: |
    Production-ready FastAPI code generation API with Clerk JWT authentication.

    ## Authentication

    All endpoints require Bearer JWT authentication via Clerk. Include your Clerk JWT token in the Authorization header:

    ```
    Authorization: Bearer <your-clerk-jwt-token>
    ```

    ## Code Generation

    The `/generate` endpoint accepts a complete API specification from the Median Code frontend and returns a production-ready FastAPI application as a downloadable zip file.

    ### Generated Application Structure

    The generated zip file contains:
    - `main.py` - FastAPI application with all defined endpoints
    - `models/` - Pydantic models for request/response validation
    - `requirements.txt` - Python dependencies
    - `README.md` - Setup and deployment instructions

    ## Request Schema

    The request body must include:
    - **metadata**: API metadata (title, version, description, base URL)
    - **tags**: Endpoint tags for OpenAPI organization
    - **endpoints**: Array of API endpoint definitions
    - **objects**: Object definitions used in requests/responses
    - **fields**: Field definitions used in objects
    - **validators**: Validator definitions applied to fields

    All IDs in the request are client-generated and used only for referencing relationships between entities (e.g., endpoint -> object -> fields).

  version: 1.0.0
  contact:
    name: Median Code Support
    url: https://app.mediancode.com

servers:
  - url: https://api.dev.mediancode.com/v1
    description: Development server
  - url: https://api.mediancode.com/v1
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: Code Generation
    description: Generate production-ready FastAPI applications

paths:
  /generate:
    post:
      tags:
        - Code Generation
      summary: Generate FastAPI application
      description: |
        Generates a complete, production-ready FastAPI application based on the provided API specification.

        The generated application includes:
        - Fully configured FastAPI app with all endpoints
        - Pydantic models for validation
        - Type hints throughout
        - OpenAPI documentation
        - Requirements file with dependencies
        - README with setup instructions

        **Returns:** A binary zip file containing the complete application structure.

        **Authentication:** Requires valid Clerk JWT token. Generated code is scoped to the authenticated user's namespace.
      operationId: generateFastAPI
      requestBody:
        required: true
        description: Complete API specification from the Median Code frontend
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
            example:
              metadata:
                id: "api-metadata-global"
                namespaceId: "namespace-global"
                title: "My API"
                version: "1.0.0"
                description: "Example API"
                baseUrl: "/api/v1"
                serverUrl: "https://api.example.com"
              tags:
                - id: "tag-1"
                  namespaceId: "namespace-global"
                  name: "Users"
                  description: "User management endpoints"
              endpoints:
                - id: "endpoint-1"
                  namespaceId: "namespace-global"
                  method: "GET"
                  path: "/users/{user_id}"
                  description: "Get user by ID"
                  tagId: "tag-1"
                  pathParams:
                    - id: "param-1"
                      name: "user_id"
                      type: "uuid"
                      description: "User identifier"
                      required: true
                  queryParamsObjectId: null
                  requestBodyObjectId: null
                  responseBodyObjectId: "object-1"
                  useEnvelope: true
                  responseShape: "object"
              objects:
                - id: "object-1"
                  namespaceId: "namespace-global"
                  name: "User"
                  description: "User object"
                  fields:
                    - fieldId: "field-1"
                      required: true
                    - fieldId: "field-2"
                      required: false
                  usedInApis: ["endpoint-1"]
              fields:
                - id: "field-1"
                  namespaceId: "namespace-global"
                  name: "user_id"
                  type: "uuid"
                  description: "User identifier"
                  defaultValue: ""
                  validators: []
                  usedInApis: ["endpoint-1"]
                - id: "field-2"
                  namespaceId: "namespace-global"
                  name: "email"
                  type: "str"
                  description: "User email"
                  defaultValue: ""
                  validators:
                    - name: "email_format"
                      params: {}
                  usedInApis: ["endpoint-1"]
              validators:
                - name: "email_format"
                  namespaceId: "namespace-global"
                  type: "string"
                  description: "Validates email format"
                  category: "inline"
                  parameterType: "None"
                  exampleUsage: "EmailStr"
                  pydanticDocsUrl: "https://docs.pydantic.dev/"
      responses:
        '200':
          description: Successfully generated FastAPI application
          content:
            application/zip:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="fastapi-app.zip"
        '400':
          description: Invalid request - validation errors in API specification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Invalid endpoint path: must start with /"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          description: Unprocessable entity - semantic errors in API specification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Referenced object 'object-999' not found in objects array"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Clerk JWT token from authentication flow

  schemas:
    # ========================================================================
    # Main Request Schema
    # ========================================================================

    GenerateRequest:
      type: object
      required:
        - metadata
        - tags
        - endpoints
        - objects
        - fields
        - validators
      properties:
        metadata:
          $ref: '#/components/schemas/ApiMetadata'
        tags:
          type: array
          items:
            $ref: '#/components/schemas/EndpointTag'
          description: Tags for organizing endpoints in OpenAPI spec
        endpoints:
          type: array
          items:
            $ref: '#/components/schemas/ApiEndpoint'
          description: Array of API endpoint definitions
        objects:
          type: array
          items:
            $ref: '#/components/schemas/ObjectDefinition'
          description: Object definitions used in requests/responses
        fields:
          type: array
          items:
            $ref: '#/components/schemas/Field'
          description: Field definitions used in objects
        validators:
          type: array
          items:
            $ref: '#/components/schemas/ValidatorBase'
          description: Validator definitions applied to fields

    # ========================================================================
    # API Metadata
    # ========================================================================

    ApiMetadata:
      type: object
      required:
        - id
        - namespaceId
        - title
        - version
        - description
        - baseUrl
        - serverUrl
      properties:
        id:
          type: string
          description: Client-generated unique identifier
          example: "api-metadata-global"
        namespaceId:
          type: string
          description: Namespace this metadata belongs to
          example: "namespace-global"
        title:
          type: string
          description: API title for OpenAPI spec
          example: "My API"
        version:
          type: string
          description: API version (semantic versioning)
          example: "1.0.0"
        description:
          type: string
          description: API description for OpenAPI spec
          example: "Production API for user management"
        baseUrl:
          type: string
          description: Base path for all endpoints
          example: "/api/v1"
        serverUrl:
          type: string
          description: Full server URL
          example: "https://api.example.com"

    # ========================================================================
    # Endpoint Tag
    # ========================================================================

    EndpointTag:
      type: object
      required:
        - id
        - namespaceId
        - name
        - description
      properties:
        id:
          type: string
          description: Client-generated unique identifier
          example: "tag-1"
        namespaceId:
          type: string
          description: Namespace this tag belongs to
          example: "namespace-global"
        name:
          type: string
          description: Tag name for OpenAPI spec
          example: "Users"
        description:
          type: string
          description: Tag description
          example: "User management endpoints"

    # ========================================================================
    # API Endpoint
    # ========================================================================

    ApiEndpoint:
      type: object
      required:
        - id
        - namespaceId
        - method
        - path
        - description
        - pathParams
        - useEnvelope
        - responseShape
      properties:
        id:
          type: string
          description: Client-generated unique identifier
          example: "endpoint-1"
        namespaceId:
          type: string
          description: Namespace this endpoint belongs to
          example: "namespace-global"
        method:
          type: string
          enum: [GET, POST, PUT, PATCH, DELETE]
          description: HTTP method
          example: "GET"
        path:
          type: string
          description: URL path with optional parameters in {braces}
          example: "/users/{user_id}"
        description:
          type: string
          description: Endpoint description for OpenAPI spec
          example: "Retrieve user by ID"
        tagId:
          type: string
          nullable: true
          description: Reference to EndpointTag.id (optional)
          example: "tag-1"
        pathParams:
          type: array
          items:
            $ref: '#/components/schemas/EndpointParameter'
          description: Path parameters extracted from URL
        queryParamsObjectId:
          type: string
          nullable: true
          description: Reference to ObjectDefinition.id for query parameters (optional)
          example: "object-query-1"
        requestBodyObjectId:
          type: string
          nullable: true
          description: Reference to ObjectDefinition.id for request body (optional - only for POST/PUT/PATCH)
          example: "object-2"
        responseBodyObjectId:
          type: string
          nullable: true
          description: Reference to ObjectDefinition.id for response body (optional)
          example: "object-1"
        useEnvelope:
          type: boolean
          description: Whether to wrap response in standard envelope (success, data, message)
          example: true
        responseShape:
          type: string
          enum: [object, list]
          description: Response data shape - single object or array of objects
          example: "object"
        expanded:
          type: boolean
          description: UI state - whether endpoint is expanded in frontend (ignored during generation)
          example: false

    # ========================================================================
    # Endpoint Parameter
    # ========================================================================

    EndpointParameter:
      type: object
      required:
        - id
        - name
        - type
        - description
        - required
      properties:
        id:
          type: string
          description: Client-generated unique identifier
          example: "param-1"
        name:
          type: string
          description: Parameter name (extracted from path {braces})
          example: "user_id"
        type:
          type: string
          description: Primitive type name
          example: "uuid"
        description:
          type: string
          description: Parameter description
          example: "Unique user identifier"
        required:
          type: boolean
          description: Whether parameter is required (path params always true)
          example: true

    # ========================================================================
    # Object Definition
    # ========================================================================

    ObjectDefinition:
      type: object
      required:
        - id
        - namespaceId
        - name
        - fields
        - usedInApis
      properties:
        id:
          type: string
          description: Client-generated unique identifier
          example: "object-1"
        namespaceId:
          type: string
          description: Namespace this object belongs to
          example: "namespace-global"
        name:
          type: string
          description: Object name (will become Pydantic model class name)
          example: "User"
        description:
          type: string
          description: Object description
          example: "User account object"
        fields:
          type: array
          items:
            $ref: '#/components/schemas/ObjectFieldReference'
          description: Fields that compose this object
        usedInApis:
          type: array
          items:
            type: string
          description: Array of endpoint IDs that use this object
          example: ["endpoint-1", "endpoint-2"]

    # ========================================================================
    # Object Field Reference
    # ========================================================================

    ObjectFieldReference:
      type: object
      required:
        - fieldId
        - required
      properties:
        fieldId:
          type: string
          description: Reference to Field.id
          example: "field-1"
        required:
          type: boolean
          description: Whether this field is required in the object
          example: true

    # ========================================================================
    # Field Definition
    # ========================================================================

    Field:
      type: object
      required:
        - id
        - namespaceId
        - name
        - type
        - validators
        - usedInApis
      properties:
        id:
          type: string
          description: Client-generated unique identifier
          example: "field-1"
        namespaceId:
          type: string
          description: Namespace this field belongs to
          example: "namespace-global"
        name:
          type: string
          description: Field name (will become Pydantic field name)
          example: "email"
        type:
          type: string
          enum: [str, int, float, bool, datetime, uuid]
          description: Primitive type name
          example: "str"
        description:
          type: string
          description: Field description
          example: "User email address"
        defaultValue:
          type: string
          description: Default value expression (Python code)
          example: ""
        validators:
          type: array
          items:
            $ref: '#/components/schemas/FieldValidator'
          description: Validators applied to this field
        usedInApis:
          type: array
          items:
            type: string
          description: Array of endpoint IDs where this field is used
          example: ["endpoint-1"]

    # ========================================================================
    # Field Validator
    # ========================================================================

    FieldValidator:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Validator name (references ValidatorBase.name)
          example: "max_length"
        params:
          type: object
          additionalProperties: true
          description: Validator parameters (optional)
          example:
            value: 255

    # ========================================================================
    # Validator Base
    # ========================================================================

    ValidatorBase:
      type: object
      required:
        - name
        - namespaceId
        - type
        - description
        - category
        - parameterType
        - exampleUsage
        - pydanticDocsUrl
      properties:
        name:
          type: string
          description: Validator name (unique within namespace)
          example: "email_format"
        namespaceId:
          type: string
          description: Namespace this validator belongs to
          example: "namespace-global"
        type:
          type: string
          enum: [string, numeric, collection]
          description: Validator type category
          example: "string"
        description:
          type: string
          description: Validator description
          example: "Validates email format"
        category:
          type: string
          enum: [inline, custom]
          description: Whether this is a Pydantic inline validator or custom
          example: "inline"
        parameterType:
          type: string
          description: Type of parameter this validator accepts
          example: "None"
        exampleUsage:
          type: string
          description: Example Pydantic code usage
          example: "EmailStr"
        pydanticDocsUrl:
          type: string
          description: URL to Pydantic documentation
          example: "https://docs.pydantic.dev/"

    # ========================================================================
    # Error Response
    # ========================================================================

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message describing what went wrong
          example: "Invalid API specification: endpoint path must start with /"

  responses:
    Unauthorized:
      description: Unauthorized - Invalid or missing Clerk JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            detail: "Not authenticated"
